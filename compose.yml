name: ocr_app

services:
  vllmocr:
    image: debeski/vllm-ocr:latest
    container_name: ocr_app
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
        limits:
          memory: 24G
          cpus: "8.0"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - JUPYTER_TOKEN=db
      - JUPYTER_PORT=8888
      - CUDA_HOME=/usr/local/cuda
      - VLLM_COMPILE=0
      - VLLM_TORCH_COMPILE_MODE=none
      - VLLM_ATTENTION_BACKEND=TRITON_ATTN
      - VLLM_TORCH_COMPILE=disable
      - VLLM_USE_FLASH_ATTENTION=0
    working_dir: /workspace
    restart: "no"
    shm_size: "8gb"
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; requests.get('http://0.0.0.0:7860', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    ports:
      - "8888:8888"
      - "7860:7860"
      - "8000:8000"
